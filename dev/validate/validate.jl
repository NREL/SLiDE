using SLiDE, DataFrames

"""
This function reads files specified in the input yaml file. BUT WITH A CATCH! If there is
a gdx and its affiliated shell script in the directory we're reading from, it will first
execute that shell script to extract the data from the gdx file before we can read the csv
files it produces.
"""
function read_with_gdx(file::String)
    y = read_file(file)
    path = joinpath(SLIDE_DIR, ensurearray(y["Path"])...)
    files = readdir(path)
    script = files[occursin.(".sh", files)][1]

    curr_dir = pwd()
    cd(path)
    run(`bash $script`)
    cd(curr_dir)

    return read_from(file)
end

"""
Given a comparison dictionary generated by `benchmark_against`, return 2 dictionaries:
    1. DataFrames indicating which indices are missing vs. present.
    2. The maximum value present where, in the benchmark DataFrame, this value is missing.
        This will tell us where we might need to cut off small values.
"""
function SLiDE.compare_keys(d::Dict)
    d = copy(d)
    [d[k] = any(.!df[:,:equal_keys]) ? df[.!df[:,:equal_keys],:] : true
        for (k,df) in d if df !== true]
    d_max = Dict(k => maximum(df[:,:calc_value]) for (k,df) in d if df !== true)
    return (d, d_max)
end

"""
This function returns a DataFrame comparing the minimum values in each input DataFrame.
A column "attn" marks minimum values of different orders of magnitude.
"""
function compare_minimum(d_calc::Dict, d_bench::Dict)
    df = DataFrame()
    for k in intersect(keys(d_calc), keys(d_bench))
        df_temp = DataFrame(param=k,
            calc=minimum(abs.(d_calc[k][:,:value])),
            bench=minimum(abs.(d_bench[k][:,:value])),
        )
        df = [df; df_temp]
    end
    df[!,:attn] .= length.(unique.(eachrow(floor.(log10.(df[:,findvalue(df)]))))) .> 1
    return df
end

function compare_tolerance(d_calc::Dict, d_bench::Dict)
    df = DataFrame()
    tols = [1e-7, 1e-6, 1e-5, 1e-4, 1e-3, 1e-2, 1e-1]
    for tol in tols
        comp = benchmark_against(d_calc, d_bench; tol = tol)
        summ = Dict(k => v !== true ? size(v,1) : 0 for (k,v) in comp)
        df = [df; [DataFrame(tol = tol) DataFrame(summ)]]
    end
    return df
end

# ------------------------------------------------------------------------------------------
dataset = "default"

VALIDATE_DIR = joinpath(SLIDE_DIR, "dev", "validate", "readfiles")
f_partition_out = joinpath(VALIDATE_DIR, "partition_o.yml")
f_calibrate_out = joinpath(VALIDATE_DIR, "cal_o.yml")
f_share_out = joinpath(VALIDATE_DIR, "share_o.yml")
f_disagg_out = joinpath(VALIDATE_DIR, "disagg_o.yml")

# ------------------------------------------------------------------------------------------
set = SLiDE.read_build(dataset, "sets")

# ------------------------------------------------------------------------------------------
# COMPARE PARTITION OUTPUTS.
io_bluenote = read_with_gdx(f_partition_out)
io = SLiDE.read_build(dataset, "partition")
d_io_comp = benchmark_against(io, io_bluenote)

# COMPARE SHARE OUTPUTS.
shr_bluenote = read_with_gdx(f_share_out)
shr_bluenote[:utd] = extrapolate_year(shr_bluenote[:utd], set[:yr])
shr = SLiDE.read_build(dataset, "share")
d_shr_comp = benchmark_against(shr, shr_bluenote)

# Here it gets a little more complicated...

# COMPARE CALIBRATION OUTPUTS.
cal_bluenote = read_with_gdx(f_calibrate_out)
cal = SLiDE.read_build(dataset, "calibrate")
d_cal_comp = benchmark_against(cal, cal_bluenote; tol = 1E-6)

(d_cal_keys, d_cal_max) = compare_keys(d_cal_comp)
df_cal_min = compare_minimum(cal, cal_bluenote)

# COMPARE DISAGGREGATIION OUTPUTS.
dis_bluenote = read_with_gdx(f_disagg_out)
dis = SLiDE.read_build(dataset, "disagg")
d_dis_comp = benchmark_against(dis, dis_bluenote; tol = 1E-6)

(d_dis_keys, d_dis_max) = compare_keys(d_dis_comp)
df_dis_min = compare_minimum(dis, dis_bluenote)

# ------------------------------------------------------------------------------------------
# COMPARE DISAGGREGATIION PROCESS.
dis_inp = merge(shr_bluenote, cal_bluenote)
set = SLiDE.read_from(joinpath(SLIDE_DIR,"src","readfiles","setlist.yml"))
(dis_process, set_process) = disagg("windc_benchmark", dis_inp, set; overwrite = true)

d_dis_process_comp = benchmark_against(dis_process, dis_bluenote; tol = 1E-6)